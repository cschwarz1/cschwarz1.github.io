<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kernel Driver Stack Smashing | home</title><meta name=keywords content><meta name=description content="First part of the series on how to develop an implant for internal security assessments"><meta name=author content="c"><link rel=canonical href=https://cschwarz1.github.io/posts/first/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d13dc9670c54a799901d8f51eb366234127600b84f76504283993a1e6bb2ffd7.css integrity="sha256-0T3JZwxUp5mQHY9R6zZiNBJ2ALhPdlBCg5k6Hmuy/9c=" rel="preload stylesheet" as=style><link rel=icon href=https://cschwarz1.github.io/favicon.ico><link rel=apple-touch-icon href=https://cschwarz1.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta name=twitter:title content="Kernel Driver Stack Smashing | home"><meta name=twitter:description content="First part of the series on how to develop an implant for internal security assessments"><meta property="og:title" content="Kernel Driver Stack Smashing | home"><meta property="og:description" content="First part of the series on how to develop an implant for internal security assessments"><meta property="og:type" content="article"><meta property="og:url" content="https://cschwarz1.github.io/posts/first/"><meta property="og:image" content="https://cschwarz1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-07T01:28:11+01:00"><meta property="article:modified_time" content="2023-02-07T01:28:11+01:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://cschwarz1.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Kernel Driver Stack Smashing","item":"https://cschwarz1.github.io/posts/first/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kernel Driver Stack Smashing | home","name":"Kernel Driver Stack Smashing","description":"First part of the series on how to develop an implant for internal security assessments","keywords":[],"wordCount":"390","inLanguage":"en","datePublished":"2023-02-07T01:28:11+01:00","dateModified":"2023-02-07T01:28:11+01:00","author":{"@type":"Person","name":"c"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cschwarz1.github.io/posts/first/"},"publisher":{"@type":"Organization","name":"home","logo":{"@type":"ImageObject","url":"https://cschwarz1.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="dark type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="dark",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://cschwarz1.github.io/ accesskey=h title="home (Alt + H)">home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://cschwarz1.github.io/categories/ title=categories>categories</a></li><li><a href=https://cschwarz1.github.io/tags/ title=tags>tags</a></li><li><a href=https://cschwarz1.github.io/aboutme/ title="about me">about me</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Kernel Driver Stack Smashing</h1><div class=post-description>First part of the series on how to develop an implant for internal security assessments</div><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>February 7, 2023</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>390 words</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>2 min</span></span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#intro aria-label=intro>intro</a><ul><ul><ul><li><a href=#a-blue-heading aria-label="A blue heading">A blue heading</a></li></ul></ul></ul></li><li><a href=#quick-overview-kernel-drivers-and-how-to-research-your-own aria-label="quick overview kernel drivers and how to research your own">quick overview kernel drivers and how to research your own</a></li><li><a href=#stack-buffer-overflows aria-label="stack buffer overflows">stack buffer overflows</a></li></ul></div></details></div><div class=post-content><h1 id=intro>intro</h1><p>In this blog post series we will take a look on we can leverage kernel driver vulnerabilites to execute arbitrary ring-0 privileged code on a fully patched win10 2202 system, how to bypass some of the current kernel protections and some caveats and pitfalls one might encounter.
At this point I can not share the specific kernel driver I used for the exploitation, as this is stil under an embargo due to responsible disclosure. The concepts however will apply to most stack based overflow vulnerabilities in kernel drivers.</p><p>Why are we doing this ?</p><p>Througout the development of the implant we assume admin privileges on a compromised host, either through stolen credentials, DNS Fallback account take-overs, compromised misconfigured web applications, etc.</p><p>Our implant will load a signed driver to execute ring-0 code and hook, bypass or simply kill the AV/EDR. We will take a look on how we can interrupt or forge telemetry and how we deal with PPL ([Protected Processes Light]) and on how we can deal with VBS.</p><p>So we made a plan, let&rsquo;s see how far this goes. I&rsquo;ll not publish detailled findings and code but if you familirize yourself with the concepts it should be doable to write your own implant you can use in your engagements. After all these concepts and techniques ar all over the internet and researched already, we will just combine the best fitting ones and throw together some code we can activley use for AV/EDR evasion.</p><p>==highlight== <em>some emphasized markdown text</em></p><p><strong>My Bold Text, in red color.</strong>{: style=&ldquo;color: red; opacity: 0.80;&rdquo; }</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>section</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;main&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=p>&lt;</span><span class=nt>h1</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;title&#34;</span><span class=p>&gt;</span>{{ .Title }}<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    {{ range .Pages }}
</span></span><span class=line><span class=cl>        {{ .Render &#34;summary&#34;}}
</span></span><span class=line><span class=cl>    {{ end }}
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>section</span><span class=p>&gt;</span>
</span></span></code></pre></div><h4 id=a-blue-heading>A blue heading</h4><p>{: .blue}</p><p>I highly suggest <code>researching</code> your own vulnerable driver as these technique will probably be valueable for quite some time. VBS is still early and think on how many win2003/win2008 server boxes are still lurking around in intranets nowadys. Kernel driver based (BYOVD) attack paths are here to stay for the foreseeable future.</p><p>So grab your [HVKD] or research your own vulnerable driver and let&rsquo;s go.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>@echo</span> <span class=n>off</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SETLOCAL</span> <span class=n>ENABLEDELAYEDEXPANSION</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-Batchfile data-lang=Batchfile><span class=line><span class=cl><span class=p>@</span><span class=k>echo</span> off
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>SETLOCAL</span> ENABLEDELAYEDEXPANSION
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>/f</span> <span class=s2>&#34;tokens=*&#34;</span> <span class=se>%%</span>a <span class=k>in</span> <span class=p>(</span>driver_list.txt<span class=p>)</span> <span class=k>do</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p><code>tsteasd 1231</code></p><h1 id=quick-overview-kernel-drivers-and-how-to-research-your-own>quick overview kernel drivers and how to research your own</h1><ul><li>fuzzy security</li><li>excellent blog connor</li><li>voidsec</li><li>jackson_t</li></ul><h1 id=stack-buffer-overflows>stack buffer overflows</h1></div><footer class=post-footer></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://cschwarz1.github.io/>home</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>